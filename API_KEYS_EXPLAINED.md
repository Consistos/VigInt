# API Keys Explained - Client vs Server

## Quick Answer

**Clients need ONLY ONE API key:**
- ✅ `VIGINT_API_KEY` - To authenticate with the Vigint server

**All other API keys are SERVER-SIDE ONLY.**

---

## Complete API Key Reference

### 1. VIGINT_API_KEY

**Purpose:** Client authentication with Vigint server  
**Used By:** Clients running `vigint/app.py`  
**Stored:** Client's `.env` file  
**Example:** `8xK9mP2nQ5rT7vW1xZ4aC6eG8hJ0kL3mN6oP9qR2sT5u...`

```bash
# Client's .env file
VIGINT_API_KEY=8xK9mP2nQ5rT7vW1xZ4aC6eG8hJ0kL3mN6oP9qR2sT5u...
```

**How it works:**
1. Client includes this in their HTTP requests
2. Server validates it against hashed keys in database
3. Server identifies which client and routes to their isolated data

**Generated by:** Server admin via `python manage_clients.py --create`

---

### 2. GOOGLE_API_KEY (aka GEMINI_API_KEY)

**Purpose:** Access Google's Gemini AI for video analysis  
**Used By:** Vigint server (`api_proxy.py`)  
**Stored:** Server's `.env` or `config.ini`  
**Never shared with clients**

```bash
# Server's .env file (NOT client's)
GOOGLE_API_KEY=AIzaSyC...
```

**Why server-side only:**
- Expensive (costs money per API call)
- Shared resource (all clients use same Gemini API)
- Security (clients shouldn't have direct access to AI)

---

### 3. SPARSE_AI_API_KEY

**Purpose:** Upload incident videos to cloud storage/hosting service  
**Used By:** Vigint server (`video_link_service.py`)  
**Stored:** Server's `.env` or `config.ini`  
**Never shared with clients**

```bash
# Server's .env file (NOT client's)
#SPARSE_AI_API_KEY=abc123def456...
#SPARSE_AI_BASE_URL=https://sparse-ai-video-server.onrender.com
```

**Why server-side only:**
- Server uploads videos after incident detection
- Clients never interact with video hosting directly
- Server generates temporary links to share videos via email

---

## Architecture Diagram

```
┌──────────────────────────┐
│     CLIENT               │
│  ┌────────────────────┐  │
│  │ .env               │  │
│  │ VIGINT_API_KEY     │◄─── Only this one!
│  └────────────────────┘  │
│         │                │
│         │ HTTP Request   │
│         │ with API key   │
└─────────┼────────────────┘
          │
          ▼
┌─────────────────────────────────────┐
│     VIGINT SERVER                   │
│  ┌───────────────────────────────┐  │
│  │ .env (SERVER CREDENTIALS)     │  │
│  │                               │  │
│  │ GOOGLE_API_KEY     ──────────┼──► Gemini AI Analysis
│  │ SPARSE_AI_API_KEY  ──────────┼──► Video Hosting
│  │ SECRET_KEY                    │  │
│  │ EMAIL_PASSWORD                │  │
│  │ STRIPE_API_KEY                │  │
│  └───────────────────────────────┘  │
│                                     │
│  ┌───────────────────────────────┐  │
│  │ Database                      │  │
│  │ - Client records              │  │
│  │ - Hashed API keys             │  │
│  │ - Usage tracking              │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

---

## Why This Separation?

### Security
- Clients can't abuse expensive AI API (GOOGLE_API_KEY)
- Clients can't access other clients' data
- Server controls all sensitive operations

### Cost Control
- Server tracks usage per client
- Server can rate-limit per client
- Single Gemini API key for billing/tracking

### Simplicity
- Clients only manage one credential
- Server manages all integrations
- Easy to rotate server-side keys without affecting clients

---

## File Templates

### For Clients: `.env.client_template`
```bash
# CLIENT CONFIGURATION
VIGINT_API_KEY=your-api-key-here

# ❌ DO NOT ADD:
# GOOGLE_API_KEY - Server-side only
# SPARSE_AI_API_KEY - Server-side only
```

### For Server: `.env.server_template`
```bash
# SERVER CONFIGURATION
GOOGLE_API_KEY=your-gemini-api-key
SPARSE_AI_API_KEY=your-sparse-ai-key
SECRET_KEY=your-secret-key
EMAIL_PASSWORD=your-email-password
DATABASE_URL=sqlite:///vigint.db
```

---

## Common Mistakes

### ❌ Mistake 1: Client puts GOOGLE_API_KEY in their .env
```bash
# Client's .env (WRONG!)
VIGINT_API_KEY=abc123...
GOOGLE_API_KEY=AIzaSy...  ← NO! This is server-side only
```

**Problem:** Unnecessary, wastes client's API quota, security risk

**Fix:** Remove GOOGLE_API_KEY from client's `.env`

---

### ❌ Mistake 2: Confusing VIGINT_API_KEY with SPARSE_AI_API_KEY

**VIGINT_API_KEY:**
- Client → Server authentication
- Unique per client
- Generated by `manage_clients.py`

**SPARSE_AI_API_KEY:**
- Server → Video hosting authentication
- Same for all clients (server-side)
- Configured once on server

---

### ❌ Mistake 3: Using .env.example for client configuration

`.env.example` is for **server administrators**, not clients.

**Clients should use:** `.env.client_template`  
**Server should use:** `.env.example` or `.env.server_template`

---

## Setup Checklist

### Client Setup
- [ ] Receive `VIGINT_API_KEY` from server admin
- [ ] Create `.env` with only `VIGINT_API_KEY`
- [ ] Run `python vigint/app.py`
- [ ] Verify connection to server

### Server Setup
- [ ] Create `.env` from `.env.example`
- [ ] Set `GOOGLE_API_KEY` (get from Google AI Studio)
- [ ] Set `SECRET_KEY` (generate with `openssl rand -hex 32`)
- [ ] Set `EMAIL_PASSWORD` (for sending alerts)
- [ ] (Optional) Set `SPARSE_AI_API_KEY` (for video hosting)
- [ ] Start server with `python api_proxy.py`

---

## Testing

### Test Client Authentication
```bash
# Client side
curl -H "X-API-Key: YOUR_VIGINT_API_KEY" \
     https://your-server.com/api/health
```

**Expected:** `{"status": "ok"}`

### Test Server AI Access
```bash
# Server side (test GOOGLE_API_KEY works)
python -c "
import os
import google.generativeai as genai
genai.configure(api_key=os.getenv('GOOGLE_API_KEY'))
print('✅ Gemini API configured')
"
```

---

## Summary

| What | Client Needs | Server Needs |
|------|--------------|--------------|
| **Authenticate client** | VIGINT_API_KEY | Database with hashed keys |
| **AI analysis** | ❌ Nothing | GOOGLE_API_KEY |
| **Video hosting** | ❌ Nothing | SPARSE_AI_API_KEY |
| **Send emails** | ❌ Nothing | EMAIL_PASSWORD |
| **Billing** | ❌ Nothing | STRIPE_API_KEY (optional) |

**Client's job:** Send video frames with their API key  
**Server's job:** Authenticate, analyze, store, bill, alert
